{% extends "base.html" %}

{% set is_en = (lang != 'ko') %}

{% block title %}
{{ 'PDF 텍스트 변환 | 무료 PDF 텍스트 추출 도구' if not is_en else 'Free PDF Text Extractor | Convert PDF to Text Online' }}
{% endblock %}

{% block head %}
<meta name="description" content="{{ '무료로 PDF에서 텍스트를 추출하세요. PDF 텍스트 변환, PDF 텍스트 추출, PDF to Text 온라인 도구.' if not is_en else 'Free online tool to extract text from PDFs instantly. Convert PDF to text for free with high accuracy.' }}">
<meta name="keywords" content="{{ 'PDF 텍스트 변환, PDF 텍스트 추출, PDF to Text, PDF 텍스트 복사, 무료 PDF 변환기' if not is_en else 'PDF to Text, Extract Text from PDF, Free PDF Text Converter, Online PDF Tool' }}">
<meta name="robots" content="index, follow">
<link rel="canonical" href="https://yourdomain.com/tools/pdf-to-text">
<meta property="og:title" content="{{ 'PDF 텍스트 변환 | 무료 PDF 텍스트 추출' if not is_en else 'PDF Text Extractor | Free PDF to Text Converter' }}">
<meta property="og:description" content="{{ 'PDF 파일에서 텍스트를 빠르게 추출하는 무료 웹 도구입니다.' if not is_en else 'Upload your PDF and extract text instantly for free.' }}">
<meta property="og:type" content="website">
<meta property="og:url" content="https://yourdomain.com/tools/pdf-to-text">
<meta property="og:image" content="https://yourdomain.com/static/images/pdf-to-text-preview.png">
{% endblock %}

{% block content %}
<main class="pdf-tool">
    <section class="pdf-hero">
        <h1>{{ 'PDF 텍스트 추출' if not is_en else 'PDF Text Extraction' }}</h1>
        <p>{{ '로컬 PDF 파일을 업로드하면 페이지별 텍스트를 빠르게 추출해 보여줍니다.' if not is_en else 'Upload your PDF to review page-by-page text instantly.' }}</p>
    </section>

    <section class="pdf-form-section">
        <form id="pdfUploadForm">
            <label for="pdfFile" class="form-label">{{ 'PDF 파일 선택' if not is_en else 'Choose PDF File' }}</label>
            <input type="file" id="pdfFile" name="pdf_file" accept=".pdf" required>
            <p class="helper-text">{{ '최대 16MB까지 업로드할 수 있습니다. 암호화된 PDF는 처리되지 않습니다.' if not is_en else 'Files up to 16MB are supported. Encrypted PDFs are not processed.' }}</p>
            <button type="submit" id="convertBtn">{{ '텍스트 추출하기' if not is_en else 'Extract Text' }}</button>
            <button type="button" id="openDownloadPopupBtn" class="secondary-btn" disabled>{{ '전체 텍스트 다운로드' if not is_en else 'Download Full Text' }}</button>
        </form>
        <div id="statusMessage" class="status-message" role="status" aria-live="polite"></div>
    </section>

    <section id="resultSection" class="pdf-result-section hidden">
        <header>
            <h2>{{ '추출 결과' if not is_en else 'Extraction Result' }}</h2>
            <button type="button" id="copyAllBtn" class="secondary-btn" disabled>{{ '전체 텍스트 복사' if not is_en else 'Copy All Text' }}</button>
        </header>
        <div id="conversionResult"></div>
    </section>
</main>

<script>
(function () {
    const form = document.getElementById('pdfUploadForm');
    const fileInput = document.getElementById('pdfFile');
    const statusMessage = document.getElementById('statusMessage');
    const resultSection = document.getElementById('resultSection');
    const resultContainer = document.getElementById('conversionResult');
    const copyAllBtn = document.getElementById('copyAllBtn');
    const convertBtn = document.getElementById('convertBtn');
    const openPopupBtn = document.getElementById('openDownloadPopupBtn');
    const MAX_FILE_SIZE = 16 * 1024 * 1024; // 16MB
    const isEnglish = {{ 'true' if is_en else 'false' }};

    const messages = {
        noFile: {{ ("먼저 PDF 파일을 선택해주세요." if not is_en else "Please select a PDF file first.") | tojson }},
        sizeError: {{ ("파일 크기가 16MB를 초과했습니다. 더 작은 PDF를 선택해주세요." if not is_en else "The file exceeds 16MB. Please choose a smaller PDF.") | tojson }},
        processing: {{ ("PDF를 처리하는 중입니다..." if not is_en else "Processing your PDF...") | tojson }},
        conversionError: {{ ("변환 중 문제가 발생했습니다." if not is_en else "A problem occurred during conversion.") | tojson }},
        emptyResult: {{ ("추출할 수 있는 텍스트가 없습니다." if not is_en else "No extractable text found in the PDF.") | tojson }},
        success: {{ ("총 {count}페이지에서 텍스트를 추출했습니다." if not is_en else "Extracted text from {count} pages.") | tojson }},
        copyEmpty: {{ ("복사할 텍스트가 없습니다." if not is_en else "There is no text to copy.") | tojson }},
        copySuccess: {{ ("전체 텍스트를 클립보드에 복사했습니다." if not is_en else "Copied all text to clipboard.") | tojson }},
        copyFail: {{ ("복사에 실패했습니다. 수동으로 복사해주세요." if not is_en else "Copy failed. Please copy manually.") | tojson }},
        downloadEmpty: {{ ("다운로드할 텍스트가 없습니다. 먼저 변환을 실행해주세요." if not is_en else "No text available to download. Please run the extraction first.") | tojson }},
        unknownError: {{ ("PDF 처리 중 알 수 없는 오류가 발생했습니다." if not is_en else "An unknown error occurred while processing the PDF.") | tojson }},
        fileEmptyError: {{ ("업로드된 파일이 비어 있습니다." if not is_en else "Uploaded file is empty.") | tojson }},
        prepareDownload: {{ ("다운로드를 준비하는 중입니다..." if not is_en else "Preparing your download...") | tojson }},
        downloadPrepFailed: {{ ("다운로드 준비에 실패했습니다. 잠시 후 다시 시도해주세요." if not is_en else "Couldn't prepare the download. Please try again shortly.") | tojson }}
    };

    let combinedTextPayload = '';

    function setStatus(message, type = 'info') {
        statusMessage.className = `status-message ${type}`;
        statusMessage.textContent = message;
    }

    function resetResults() {
        resultContainer.innerHTML = '';
        resultSection.classList.add('hidden');
        statusMessage.className = 'status-message';
        statusMessage.textContent = '';
        copyAllBtn.disabled = true;
        openPopupBtn.disabled = true;
        combinedTextPayload = '';
    }

    function htmlEscape(text) {
        return text.replace(/[&<>"']/g, (char) => ({
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#39;',
        }[char]));
    }

    form.addEventListener('submit', async (event) => {
        event.preventDefault();
        resetResults();

        if (!fileInput.files.length) {
            setStatus(messages.noFile, 'error');
            return;
        }

        const selectedFile = fileInput.files[0];
        if (selectedFile.size > MAX_FILE_SIZE) {
            setStatus(messages.sizeError, 'error');
            return;
        }

        if (selectedFile.size === 0) {
            setStatus(messages.fileEmptyError, 'error');
            return;
        }

        setStatus(messages.processing, 'loading');
        convertBtn.disabled = true;
        openPopupBtn.disabled = true;

        const formData = new FormData();
        formData.append('pdf_file', selectedFile);

        try {
            const response = await fetch('/api/pdf-to-text', {
                method: 'POST',
                body: formData,
            });

            const data = await response.json();

            if (!response.ok) {
                setStatus(data.error || messages.conversionError, 'error');
                return;
            }

            if (data.error) {
                setStatus(data.error, 'error');
                return;
            }

            const pages = Array.isArray(data.pages) ? data.pages : [];
            if (!pages.length) {
                setStatus(data.message || messages.emptyResult, 'warning');
                return;
            }

            resultSection.classList.remove('hidden');
            setStatus(messages.success.replace('{count}', data.total_pages), 'success');

            const fragment = document.createDocumentFragment();
            const combinedSegments = [];
            pages.forEach(({ page, text }) => {
                const details = document.createElement('details');
                details.open = pages.length === 1;

                const summary = document.createElement('summary');
                summary.textContent = `${isEnglish ? 'Page' : '페이지'} ${page}`;

                const pre = document.createElement('pre');
                pre.innerHTML = htmlEscape(text || (isEnglish ? '[No text]' : '[텍스트 없음]'));

                details.appendChild(summary);
                details.appendChild(pre);
                fragment.appendChild(details);

                combinedSegments.push(`${isEnglish ? '--- Page' : '--- 페이지'} ${page} ---\n${text || ''}`);
            });

            resultContainer.appendChild(fragment);
            combinedTextPayload = combinedSegments.join('\n\n');
            const hasText = Boolean(combinedTextPayload.trim());
            copyAllBtn.disabled = !hasText;
            openPopupBtn.disabled = !hasText;

            if (data.message && !isEnglish) {
                const info = document.createElement('p');
                info.className = 'warning';
                info.textContent = data.message;
                resultContainer.insertBefore(info, resultContainer.firstChild);
            } else if (data.message && isEnglish) {
                const info = document.createElement('p');
                info.className = 'warning';
                info.textContent = data.message;
                resultContainer.insertBefore(info, resultContainer.firstChild);
            }
        } catch (error) {
            console.error('PDF conversion failed', error);
            setStatus(messages.unknownError, 'error');
        } finally {
            convertBtn.disabled = false;
            if (!combinedTextPayload) {
                openPopupBtn.disabled = true;
            }
        }
    });

    copyAllBtn.addEventListener('click', async () => {
        const texts = [...resultContainer.querySelectorAll('pre')].map(pre => pre.textContent);
        if (!texts.length) {
            setStatus(messages.copyEmpty, 'warning');
            return;
        }

        try {
            await navigator.clipboard.writeText(texts.join('\n\n'));
            setStatus(messages.copySuccess, 'success');
        } catch (err) {
            console.error('Copy failed', err);
            setStatus(messages.copyFail, 'error');
        }
    });

    openPopupBtn.addEventListener('click', () => {
        if (!combinedTextPayload) {
            setStatus(messages.downloadEmpty, 'warning');
            return;
        }

        openPopupBtn.disabled = true;
        setStatus(messages.prepareDownload, 'loading');

        fetch('/api/pdf-to-text/buffer', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ text: combinedTextPayload })
        })
            .then(async (response) => {
                const data = await response.json();
                if (!response.ok || !data.token) {
                    throw new Error(data.error || 'TOKEN_ERROR');
                }
                window.location.href = `/tools/pdf-to-text/download?token=${encodeURIComponent(data.token)}`;
            })
            .catch((error) => {
                console.error('Failed to prepare download', error);
                setStatus(messages.downloadPrepFailed, 'error');
                openPopupBtn.disabled = false;
            });
    });
})();
</script>

<style>
    .pdf-tool {
        max-width: 900px;
        margin: 30px auto;
        background: rgba(0, 0, 0, 0.35);
        border-radius: 16px;
        padding: 30px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.25);
    }

    .pdf-hero {
        text-align: center;
        margin-bottom: 24px;
    }

    .pdf-hero h1 {
        margin-bottom: 12px;
        font-size: 2rem;
    }

    .pdf-form-section {
        background: rgba(255, 255, 255, 0.08);
        padding: 24px;
        border-radius: 12px;
    }

    .pdf-form-section form {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .form-label {
        font-weight: 600;
    }

    input[type="file"] {
        padding: 10px;
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.3);
        background: rgba(0, 0, 0, 0.2);
        color: #fff;
    }

    button {
        padding: 12px 16px;
        border: none;
        border-radius: 8px;
        background: #ffdd00;
        color: #000;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.1s ease, box-shadow 0.1s ease;
    }

    button:hover:not(:disabled) {
        transform: translateY(-1px);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
    }

    button:disabled {
        cursor: not-allowed;
        opacity: 0.6;
    }

    .secondary-btn {
        background: #fff;
        font-size: 0.9rem;
    }

    .helper-text {
        font-size: 0.85rem;
        color: rgba(255, 255, 255, 0.8);
        margin-top: -6px;
    }

    .status-message {
        margin-top: 12px;
        padding: 10px 14px;
        border-radius: 8px;
        background: rgba(0, 0, 0, 0.2);
        font-size: 0.95rem;
    }

    .status-message.loading {
        background: rgba(0, 150, 255, 0.2);
    }

    .status-message.success {
        background: rgba(0, 200, 83, 0.25);
    }

    .status-message.error {
        background: rgba(255, 82, 82, 0.25);
    }

    .status-message.warning {
        background: rgba(255, 214, 0, 0.3);
        color: #000;
    }

    .pdf-result-section {
        margin-top: 30px;
        background: rgba(255, 255, 255, 0.08);
        padding: 24px;
        border-radius: 12px;
    }

    .pdf-result-section header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 16px;
        flex-wrap: wrap;
    }

    details {
        background: rgba(0, 0, 0, 0.35);
        border-radius: 8px;
        margin-top: 16px;
        padding: 12px 16px;
    }

    summary {
        cursor: pointer;
        font-weight: 600;
        outline: none;
    }

    pre {
        white-space: pre-wrap;
        word-break: break-word;
        margin-top: 12px;
        padding: 12px;
        background: rgba(0, 0, 0, 0.35);
        border-radius: 8px;
        max-height: 420px;
        overflow-y: auto;
        font-size: 0.95rem;
    }

    .hidden {
        display: none;
    }

    @media (max-width: 600px) {
        .pdf-tool {
            margin: 16px;
            padding: 20px;
        }

        button {
            width: 100%;
        }
    }
</style>
{% endblock %}
