<!DOCTYPE html>
<html lang="{{ 'ko' if lang == 'ko' else 'en' }}">
<head>
    <meta charset="UTF-8">
    <title>{{ 'PDF 텍스트 다운로드 준비 중' if lang == 'ko' else 'Preparing PDF Text Download' }}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex">
    <style>
        body {
            margin: 0;
            font-family: 'Pretendard', Arial, sans-serif;
            background: linear-gradient(135deg, #1c1c35 0%, #2a2a4f 50%, #3d3d6d 100%);
            color: #f5f5f5;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        header, footer {
            padding: 24px;
            text-align: center;
        }
        main {
            flex: 1;
            padding: 0 24px 32px;
            display: flex;
            flex-direction: column;
            gap: 24px;
            max-width: 800px;
            margin: 0 auto;
        }
        .card {
            background: rgba(0, 0, 0, 0.35);
            border-radius: 16px;
            padding: 28px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.25);
        }
        .card h2 {
            margin-top: 0;
            font-size: 1.5rem;
        }
        .ad-slot {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            padding: 24px;
            min-height: 180px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: rgba(255, 255, 255, 0.7);
            text-align: center;
            font-size: 0.95rem;
            border: 1px dashed rgba(255, 255, 255, 0.25);
        }
        .download-section {
            text-align: center;
        }
        .status {
            margin-top: 16px;
            font-size: 1rem;
        }
        .timer {
            margin-top: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            color: #ffdd00;
        }
        button {
            margin-top: 20px;
            padding: 14px 22px;
            border: none;
            border-radius: 10px;
            background: #ffdd00;
            color: #000;
            font-weight: 700;
            font-size: 1.05rem;
            cursor: pointer;
            transition: transform 0.12s ease, box-shadow 0.12s ease;
        }
        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 12px 20px rgba(0, 0, 0, 0.25);
        }
        button:disabled {
            opacity: 0.55;
            cursor: not-allowed;
        }
        footer {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.65);
        }
    </style>
</head>
<body>
    <header>
        <h1>{{ '텍스트 다운로드를 준비하고 있습니다' if lang == 'ko' else 'Preparing your text download' }}</h1>
        <p>{{ '잠시만 기다려주세요. 다운로드 버튼이 활성화됩니다.' if lang == 'ko' else 'Please wait a moment. The download button will activate after this short notice.' }}</p>
    </header>
    <main>
        <section class="card download-section">
            <h2>{{ '다운로드 준비 상태' if lang == 'ko' else 'Download Preparation' }}</h2>
            <p>{{ '안전한 다운로드를 위해 잠시만 기다려주세요.' if lang == 'ko' else 'Please wait a moment while we prepare your download securely.' }}</p>
            <button type="button" id="downloadNowBtn" disabled>{{ '다운로드 시작' if lang == 'ko' else 'Start Download' }}</button>
            <div id="downloadTimer" class="timer"></div>
            <div id="downloadStatus" class="status">{{ '서버와 연결을 확인하는 중입니다...' if lang == 'ko' else 'Connecting to the server...' }}</div>
        </section>

        <section class="card">
            <h2>{{ '잠깐! 다운로드 전에 이런 정보는 어떠세요?' if lang == 'ko' else 'Spotlight before you download' }}</h2>
            <div class="ad-slot">
                {{ '5초만 기다리시면 다운로드 버튼이 열립니다.' if lang == 'ko' else 'Your sponsored message appears here. The download button unlocks in 5 seconds.' }}
            </div>
        </section>
    </main>
    <footer>
        {{ '광고 수익은 서비스 유지 및 개선에 사용됩니다.' if lang == 'ko' else 'Ad revenue helps maintain and improve this service.' }}
    </footer>

    <script>
    (function () {
        const statusEl = document.getElementById('downloadStatus');
        const timerEl = document.getElementById('downloadTimer');
        const downloadBtn = document.getElementById('downloadNowBtn');
        const COUNTDOWN_SECONDS = 5;
        const downloadToken = {{ token|tojson }};

        const messages = {
            timer: {{ ("{sec}초 후 다운로드 버튼이 활성화됩니다." if lang == 'ko' else "Download button activates in {sec} seconds.") | tojson }},
            ready: {{ ("다운로드 준비가 완료되었습니다!" if lang == 'ko' else "Download is ready!") | tojson }},
            clickToSave: {{ ("다운로드 버튼을 눌러 텍스트 파일을 저장해주세요." if lang == 'ko' else "Click the button below to save your text file.") | tojson }},
            textReady: {{ ("텍스트가 준비되었습니다. 잠시 후 다운로드 버튼이 활성화됩니다." if lang == 'ko' else "Text received. The download button will activate shortly.") | tojson }},
            emptyText: {{ ("전달받은 텍스트가 비어 있습니다. 원본 페이지에서 다시 시도해주세요." if lang == 'ko' else "Received text is empty. Please retry from the source page.") | tojson }},
            notFound: {{ ("다운로드할 텍스트를 찾을 수 없습니다. 원본 페이지에서 다시 시도해주세요." if lang == 'ko' else "No text available to download. Please retry from the main page.") | tojson }},
            noText: {{ ("다운로드할 텍스트가 없습니다. 다시 시도해주세요." if lang == 'ko' else "No text available. Please try again.") | tojson }},
            startStatus: {{ ("서버에서 텍스트를 불러오는 중입니다..." if lang == 'ko' else "Fetching your text from the server...") | tojson }},
            downloadStarted: {{ ("다운로드가 시작되었습니다. 이용해주셔서 감사합니다!" if lang == 'ko' else "Download started. Thank you for using our tool!") | tojson }},
            invalidToken: {{ ("다운로드 토큰이 유효하지 않습니다. 처음부터 다시 시도해주세요." if lang == 'ko' else "The download link is invalid. Please start again from the extraction page.") | tojson }},
            fetchFailed: {{ ("텍스트를 불러오는 중 오류가 발생했습니다. 잠시 후 다시 시도해주세요." if lang == 'ko' else "We ran into a problem fetching the text. Please try again shortly.") | tojson }}
        };

        let receivedText = '';
        let countdownTimer = null;

        function setStatus(message) {
            statusEl.textContent = message;
        }

        function startCountdown() {
            let remaining = COUNTDOWN_SECONDS;
            timerEl.textContent = messages.timer.replace('{sec}', remaining);

            countdownTimer = setInterval(() => {
                remaining -= 1;
                if (remaining > 0) {
                    timerEl.textContent = messages.timer.replace('{sec}', remaining);
                } else {
                    clearInterval(countdownTimer);
                    timerEl.textContent = messages.ready;
                    downloadBtn.disabled = false;
                    setStatus(messages.clickToSave);
                }
            }, 1000);
        }

        async function loadText() {
            if (!downloadToken) {
                setStatus(messages.invalidToken);
                return;
            }

            setStatus(messages.startStatus);

            try {
                const response = await fetch(`/api/pdf-to-text/buffer/${encodeURIComponent(downloadToken)}`);
                const data = await response.json();

                if (!response.ok || !data.text) {
                    setStatus(data.error || messages.notFound);
                    timerEl.textContent = '';
                    return;
                }

                receivedText = data.text;
                setStatus(messages.textReady);
                startCountdown();
            } catch (error) {
                console.error('Failed to fetch text for download', error);
                setStatus(messages.fetchFailed);
                timerEl.textContent = '';
            }
        }

        downloadBtn.addEventListener('click', () => {
            if (!receivedText) {
                setStatus(messages.noText);
                return;
            }

            const blob = new Blob([receivedText], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `pdf_text_${new Date().toISOString().replace(/[:.]/g, '-')}.txt`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            setStatus(messages.downloadStarted);
        });

        loadText();
    })();
    </script>
</body>
</html>
